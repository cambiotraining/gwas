{
  "hash": "8244a4894e7b9f0e559670fb3f69f00d",
  "result": {
    "engine": "knitr",
    "markdown": "---\npagetitle: GWAS\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# Variant QC\n\n:::{.callout-tip}\n#### Learning objectives\n\n- List metrics that can be used for variant-level quality control and filtering.\n- Use PLINK to calculate genotype call rates, minor allele frequency and deviations from Hardy-Weinberg equilibrium.\n- Analyse quality metric results in R and assess the need for filtering in downstream analyses. \n- Discuss how these quality metrics are impacted by population structure. \n- Produce a set of uncorrelated variants using linkage disequilibrium pruning.\n:::\n\n## Per-variant metrics\n\nBefore proceeding with downstream analyses, it's good practice to investigate quality issues in our variants. \nWe will consider the following metrics for each variant: \n\n- **Call rate**: Fraction of missing genotypes. Variants with a high fraction of missing data may indicate overall low quality and thus be removed from downstream analysis.\n- **Allele frequency**: The frequency of the allele in the population of samples. Variants with low frequency (rare alleles) are usually excluded from downstream analysis as they incur low statistical power for association tests. \n- **Hardy-Weinberg deviations**: In randomly mating populations, there is a theoretical expectation of how many homozygous and heterozygous individuals there should be given the frequency of the two alleles. Deviations from this expectation may be due to genotyping errors.\n\nWe will cover each of these below. \n\n\n:::{.callout-important}\n#### Set up your R session\n\nIf you haven't done so already, start an R session with the following packages loaded: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the libraries\nlibrary(tidyverse) # data manipulation\nlibrary(patchwork) # to compose plots\nlibrary(janitor)   # to clean column names\ntheme_set(theme_minimal()) # change default ggplot2 theme\n```\n:::\n\n\n\n\n:::\n\n\n## Call rates\n\nOne way to assess the genotype quality of each variant is to calculate how many missing genotypes each sample has. \nThis can then be used to assess the need to exclude variants from our downstream analysis. \nThere are no set rules as to what constitutes a \"good call rate\", but typically we may exclude variants with more than ~5% of missing genotypes. \nThis threshold may vary, however, depending on the nature of data you have. \n\n:::{.callout-exercise}\n#### Missing genotype data \n\n- Look at [PLINK's documentation](https://www.cog-genomics.org/plink/2.0/basic_stats) to find the option that calculates missing data reports. \n- Run PLINK with that option, recalling the basic command structure: \n\n    ```bash\n    plink2 \\\n      --pfile data/plink/1000G_subset \\\n      --out results/1000G_subset \\\n      OPTION-HERE\n    ```\n\n- Look at the top lines of the output files from the terminal (using `head`), to see if you understand their structure. \n  You can also consult PLINK's [file format documentation](https://www.cog-genomics.org/plink/2.0/formats). \n\n:::{.callout-answer}\n\nThe option we were being asked to use is called `--missing`, which [the documentation](https://www.cog-genomics.org/plink/2.0/basic_stats#missing) says: \"produces sample-based and variant-based missing data reports\".\n\nWe therefore run the command:\n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset \\\n  --missing\n```\n\nThis generates two files with extension `.smiss` (for sample-missingness report) and `.vmiss` (for variant-missingness report).\nThe [file format documentation](https://www.cog-genomics.org/plink/2.0/formats) details the columns present in each of these files. \n\nWe can quickly look at the top rows of each file using the standard `head` command from our terminal: \n\n```bash\nhead results/1000G_subset.vmiss\n```\n\n```\n#CHROM  ID      MISSING_CT      OBS_CT  F_MISS\n1       rs1639560406    0       1037    0\n1       rs1463012642    21      1037    0.0202507\n1       rs1200541360    0       1037    0\n1       rs1472769893    0       1037    0\n1       rs1422057391    0       1037    0\n1       rs540466151     0       1037    0\n1       rs1167386110    0       1037    0\n1       rs1478422777    4       1037    0.00385728\n1       rs1365462007    7       1037    0.00675024\n```\n\n:::\n:::\n\nIn the previous exercise, you should have produced a file containing the counts and frequency of missing genotypes for each variant. \nAs [we did before](02-plink.md) for the allele frequency file, we can import this table into R:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvmiss <- read_tsv(\"results/1000G_subset.vmiss\") |> \n  clean_names(replace = c(\"#\" = \"\"))\n  \n# inspect the table\nhead(vmiss)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  chrom id           missing_ct obs_ct f_miss\n  <chr> <chr>             <dbl>  <dbl>  <dbl>\n1 1     rs1639560406          0   1037 0     \n2 1     rs1463012642         21   1037 0.0203\n3 1     rs1200541360          0   1037 0     \n4 1     rs1472769893          0   1037 0     \n5 1     rs1422057391          0   1037 0     \n6 1     rs540466151           0   1037 0     \n```\n\n\n:::\n:::\n\n\n\n\nWe can tabulate how many variants have missing genotypes: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(vmiss$missing_ct > 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  FALSE    TRUE \n3409393 1065311 \n```\n\n\n:::\n:::\n\n\n\n\nAround 24% of variants have a missing genotype in at least one of the samples. \nFor those, we can plot the missing rate distribution:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvmiss |> \n  filter(f_miss > 0) |> \n  ggplot(aes(f_miss)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](03-qc_variants_files/figure-html/vmiss-hist-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can see most of these SNVs have relatively low rates of missing data. \n\nWe can see what fraction of variants would be discarded if we used the conventional 5% threshold: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(vmiss$f_miss > 0.05)/nrow(vmiss)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.001427357\n```\n\n\n:::\n:::\n\n\n\n\nAt this threshold we will discard 6387 variants, which we can see is a very small fraction of the variants we have. \nWe can therefore be satisfied that, in general, there are no major issues with our call rates.\n\nIn our downstream analyses, we can exclude variants with >5% missing data by adding the option `--geno 0.05` to PLINK. \n\n\n## Allele frequency\n\nIn the [previous chapter](02-plink.qmd) we already saw how to calculate the allele frequency of our variants using the `--freq` option.\n\nWe can read this file into R as usual:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nafreq <- read_tsv(\"results/1000G_subset.afreq\") |> \n  clean_names(replace = c(\"#\" = \"\"))\n  \nhead(afreq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  chrom id           ref   alt   alt_freqs obs_ct\n  <dbl> <chr>        <chr> <chr>     <dbl>  <dbl>\n1     1 rs1639560406 A     C      0          2074\n2     1 rs1463012642 C     T      0.00344    2032\n3     1 rs1200541360 T     C      0.00193    2074\n4     1 rs1472769893 G     C      0.000964   2074\n5     1 rs1422057391 C     T      0.000964   2074\n6     1 rs540466151  T     G      0.000482   2074\n```\n\n\n:::\n:::\n\n\n\n\nBy default PLINK calculates the allele frequency of the alternative allele. \nHowever, this is somewhat arbitrary, as the alternative allele is simply defined as the allele that different from whichever happens to be the reference genome. \nA more common approach is to visualise the **minor allele frequency (MAF)**, i.e. the frequency of the least-common alelle in the population. \n\nWe can calculate the MAF for each variant, adding it as a new column to our data frame, followed by a new histogram:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add a column of minor allele frequency\nafreq <- afreq |> \n  mutate(maf = ifelse(alt_freqs > 0.5, 1 - alt_freqs, alt_freqs)) \n\n# MAF histogram\nafreq |> \n  ggplot(aes(maf)) +\n  geom_histogram(binwidth = 0.01)\n```\n\n::: {.cell-output-display}\n![](03-qc_variants_files/figure-html/maf-hist-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can see the histogram is quite skewed, with many SNPs having very low frequency. \nIn fact, some of them are not variable at all in our samples!\nWe can quickly tabulate how many SNPs are above the commonly-used 1% threshold of allele frequency: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(afreq$maf > 0.01)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  FALSE    TRUE \n3474658  876844 \n```\n\n\n:::\n:::\n\n\n\n\nWe can see that the majority of variants have very low frequency. \nThese must be variants that have been found to vary in other individuals of the 1000 genomes project, but happen to be invariant in our relatively small collection of samples. \n\nLow frequency variants are often filtered out when performing downstream analyses, such as the association test. \nThis is because they have low statistical power, leading to noisy estimates (you can think of it as having a low sample size for one of the classes of genotypes). \n\nTo exclude variants with low minor allele frequency, for example at a 1% threshold, we can use PLINK's option `--maf 0.01`.\n\n\n## Hardy–Weinberg\n\nAnother quality control step is to check whether SNPs significantly deviate from Hardy-Weinberg equilibrium, which is expected if individuals mate randomly. \n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset \\\n  --chr 1-22 \\\n  --hardy\n```\n\nThis outputs a file with `.hardy` extension, which we can read into R: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhardy <- read_tsv(\"results/1000G_subset.hardy\") |> \n  clean_names(replace = c(\"#\" = \"\"))\n  \nhead(hardy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 10\n  chrom id    a1    ax    hom_a1_ct het_a1_ct two_ax_ct o_het_a1 e_het_a1      p\n  <dbl> <chr> <chr> <chr>     <dbl>     <dbl>     <dbl>    <dbl>    <dbl>  <dbl>\n1     1 rs16… A     C          1037         0         0 0        0        1     \n2     1 rs14… C     T          1010         5         1 0.00492  0.00687  0.0103\n3     1 rs12… T     C          1033         4         0 0.00386  0.00385  1     \n4     1 rs14… G     C          1035         2         0 0.00193  0.00193  1     \n5     1 rs14… C     T          1035         2         0 0.00193  0.00193  1     \n6     1 rs54… T     G          1036         1         0 0.000964 0.000964 1     \n```\n\n\n:::\n:::\n\n\n\n\nOne possible visualisation of these data is to plot the expected heterozygosity versus the observed heterozygosity and colour the points as to whether they are below a chosen p-value threshold:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhardy |> \n  # randomply sample SNPs \n  # to avoid plot window from crashing\n  sample_n(10e3) |> \n  ggplot(aes(e_het_a1, o_het_a1)) + \n  geom_point(aes(colour = p < 0.001)) +\n  geom_abline() +\n  labs(x = \"Expected heterozygosity\", y = \"Observed heterozygosity\")\n```\n\n::: {.cell-output-display}\n![](03-qc_variants_files/figure-html/hardy-scatter-1.png){width=672}\n:::\n:::\n\n\n\n\nFrom this plot, we can see an excess of SNVs with **lower heterozygosity** than expected compared to those with higher heterozygosity. \nThis discrepancy is because our samples originate from diverse global regions that do not form a \"randomly mating population\". \n\nAs an example, consider a variant present in one geographical area (e.g., individuals from a specific country) but absent elsewhere. \nThe Hardy-Weinberg equilibrium assumes random mating across the entire population, therefore variants with limited geographic distribution may appear to have an excess of homozygotes. \nIn reality, these variants are simply missing from certain populations.\n\nSo, while variants might fit Hardy-Weinberg expectations within randomly mating sub-populations, they will seem to deviate from it when these groups are pooled together. \nThis phenomenon is known as the **Wahlund effect** and results from **population structure**, a topic which we return to in a later chapter. \n\nIn downstream analysis, we can exclude SNPs with a low p-value for the Hardy-Weinberg deviation test. \nHowever, due to the population structure issue just discussed, we only exclude SNPs with higher-than-expected heterozygosity. \nHigh rates of heterozygosity may indicate genotyping errors, which we want to eliminate. \nWehreas low rates of heterozygosity may simply be due to population structure, which we want to retian. \nTo discard only high heterozygosity SNVs having p-value < 0.001, we can use the option `--hwe 0.001 keep-fewhe`. \n\n\n:::{.callout-tip}\n#### Tip: Running multiple options at once\n\nWe have seen a few PLINK commands that are useful for checking properties of our genotype data: \n\n- `--missing` to assess genotype missingness both across SNPs and samples.\n- `--freq` to assess the allele frequency across SNPs.\n- `--hardy` to assess genotype frequency deviations from the Hardy-Weinberg equilibrium expectation. \n\nSo far, we have run each of these options individually, however you can run multiple options simultaneously. \nFor example, our previous analyses could have been run with a single command: \n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset \\\n  --chr 1-22 \\\n  --freq --hardy --missing\n```\n\nThis would produce all three respective results files in one go. \n:::\n\n\n## LD prunning\n\nBefore proceeding with our next quality checks, we will perform a **linkage disequilibrium (LD) pruning** step.\nThis is a process that identifies variants that are in high linkage disequilibrium with each other, i.e. they are correlated and therefore provide redundant information.\n\nHaving a set of uncorrelated variants (i.e. in linkage equilibrium) is useful for many downstream analyses, such as principal component analysis (PCA) and estimates of individual inbreeding, which we will cover in the next chapter.\n\nIdentify variants in linkage equilibrium, we can use the `--indep-pairwise` option in PLINK. \nThis option requires at least two options:\n\n- **Window size**: how many neighbouring variants are considered at each step of the algorithm.\n- **R-squared threshold**: how correlated the variants need to be in order to be prunned.\n\nThe algorithm then proceeds by sliding a window of the specified size across the genome, calculates the correlation for each pair of variants in that window, and prunes one of them if the correlation is above the specified threshold.\n\nFor our analysis, we will use a window size of 100 variants and an r-squared threshold of 0.8:\n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset \\\n  --chr 1-22 --hwe 0.001 keep-fewhe --maf 0.01 \\\n  --indep-pairwise 100 0.8\n```\n\nWe have also restricted the analysis to chromosomes 1-22, as our main downstream analyses will only consider autosomes.\nAnd we exclude sites that have excess heterozygosity (i.e. those that deviate from Hardy-Weinberg equilibrium) and low minor allele frequency (MAF < 1%).\n\nThe command above produces two files with the suffix `.prune.in` (variants that were kept by the algorithm, i.e. they should be largely uncorrelated) and `.prune.out` (the variants that were eliminated).\n\nThese files simply have a single column with the variant IDs:\n\n```bash\nhead results/1000G_subset.prune.in\n```\n\n```\nrs1463012642\nrs1200541360\nrs1472769893\nrs1422057391\nrs540466151\nrs1478422777\nrs1365462007\nrs1385614989\nrs1385058577\nrs533630043\n```\n\nNow, in downstream analyses where we only want to use uncorrelated SNPs (e.g., PCA, sample inbreeding, relatedness), we can use the `--extract` option to use only the variants in the `.prune.in` file.\n\n\n## Summary\n\n::: {.callout-tip}\n#### Key Points\n\n- Key metrics for variant-level quality control include: call rate, minor allele frequency and Hardy-Weinberg equilibrium.\n- Call rates (`--missing`): variants with low call rates (e.g. <95% or >5% missing data) are typically excluded. \n  - To remove variants with missing data above a certain threshold use `--geno X` (replace `X` with the desired fraction, e.g. 0.05). \n- Minor allele frequency (`--maf`): very rare variants (e.g. <1%) have low statistical power and are usually removed from downstream analysis. \n  - To remove variants with MAF below a certain threshold use `--maf X` (replace `X` with the desired frequency, e.g. 0.01).\n- Hardy-Weinberg equilibrium: variants for which genotype frequencies of homozygotes and heterozygous individuals deviate from expectation are removed as they may be due to genotyping errors, inbreeding, and other causes. \n  - Care should be taken with this statistic, as an excess of homozygotes is expected if there are different sub-populations within the sample being analysed (e.g. samples from different geographic regions). \n  - Genotyping errors usually result in an excess of heterozygous, and these can be removed using `--hwe X keep-fewhe` (replace `X` with a p-value threshold, typically a low value such as 0.001).\n- Linkage disequilibrium (LD) pruning (`--indep-pairwise`): identifies variants that in high LD with each other, i.e. they are correlated and therefore provide redundant information. \n  - Useful for downstream analyses, such as PCA, estimating individual inbreeding and relatedness between samples.\n  - To perform LD pruning use `--indep-pairwise X Y` (replace `X` with the window size, e.g. 100, and `Y` with the r-squared threshold, e.g. 0.8).\n:::\n",
    "supporting": [
      "03-qc_variants_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}