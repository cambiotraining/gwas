{
  "hash": "17c745068109c2c4e19aace7bc3913b8",
  "result": {
    "engine": "knitr",
    "markdown": "---\npagetitle: GWAS\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# Association analysis\n\n:::{.callout-tip}\n#### Learning objectives\n\n- Fit a GLM model to trait data using PLINK.\n- Generate Q-Q plots for the p-values from the association test, and use them to assess over- or under-inflation issues.\n- Recognise and apply correction for population structure in the GLM.\n- Produce Manhattan plots to visualise the association results across the genome.\n- Explore the association results and refine visualisations to focus on particular regions of interest.\n:::\n\n\n## Association analysis\n\nCommand to run GLM:\n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset_nocovar \\\n  --maf 0.01 --hwe 0.001 keep-fewhet \\\n  --pheno data/phenotypes.tsv \\\n  --glm allow-no-covars\n```\n\nSetup our R session:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the libraries\nlibrary(tidyverse) # data manipulation\nlibrary(patchwork) # to compose plots\nlibrary(janitor)   # to clean column names\ntheme_set(theme_minimal())\n```\n:::\n\n\n\n\n\nImport the data and create custom theme for Manhattan plots: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee <- read_tsv(\"results/1000G_subset_nocovar.coffee.glm.linear\") |> \n  clean_names()\n  \nmanhattan_theme <- theme_minimal() +\n  theme(\n    axis.text.x = element_blank(),\n    axis.ticks.x = element_blank(),\n    panel.grid = element_blank(),\n    panel.spacing = unit(0.1, \"lines\"),\n    strip.background = element_blank()\n  )\n```\n:::\n\n\n\n\nQ-Q plot: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee |> \n  arrange(p) |> \n  mutate(expected = -log10(ppoints(n())), \n         observed = -log10(p)) |> \n  # retain all p-values below 0.001\n  # but only ~5% of those above that threshold\n  filter(p <= 0.001 | (p > 0.001 & runif(n()) < 0.05)) |> \n  ggplot(aes(expected, observed)) +\n  geom_point() +\n  geom_abline()\n```\n\n::: {.cell-output-display}\n![](02-association_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\nInflation factor:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedian(qchisq(coffee$p, df=1, lower.tail = F), na.rm = T)/qchisq(0.5, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 4.508669\n```\n\n\n:::\n:::\n\n\n\n\nManhattan plot shows clear peaks, but generally inflated (notice everything is essentially above the threshold):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee |> \n  filter(p < 0.001) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point() +\n  geom_hline(yintercept = -log10(5e-8), colour = \"firebrick\", lwd = 1) +\n  facet_grid(~ number_chrom, \n             scale = \"free_x\", \n             space = \"free_x\") + \n  manhattan_theme\n```\n\n::: {.cell-output-display}\n![](02-association_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can look a distribution of our trait value across world regions and see there are differences across the continents, which will counfound the results:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npheno <- read_tsv(\"data/phenotypes.tsv\")\nsample_info <- read_tsv(\"data/sample_info.tsv\")\n\nsample_info |> \n  full_join(pheno, by = c(\"individual_id\" = \"IID\")) |> \n  ggplot(aes(super_pop, coffee)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](02-association_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Correct for population structure\n\nWe now re-run the GLM, using PCA eigenvectors as covariates in the model:\n\n```bash\nplink2 \\\n  --pfile data/plink/1000G_subset \\\n  --out results/1000G_subset_pca \\\n  --maf 0.01 --hwe 0.001 keep-fewhet \\\n  --pheno data/phenotypes.tsv \\\n  --glm \\\n  --covar results/1000G_subset.eigenvec\n```\n\nWe can import and visualise the new results:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee_pca <- read_tsv(\"results/1000G_subset_pca.coffee.glm.linear\") |> \n  clean_names()\n  \n# retain only the SNP test results\ncoffee_pca <- coffee_pca |> \n  filter(test == \"ADD\")\n\n# histogram of p-values\ncoffee_pval_hist <- coffee_pca |> \n  arrange(p) |> \n  mutate(expected = -log10(ppoints(n())), \n         observed = -log10(p)) |> \n  filter(p <= 0.001 | (p > 0.001 & runif(n()) < 0.01)) |> \n  ggplot(aes(p)) +\n  geom_histogram(binwidth = 0.01) +\n  labs(title = \"P-value histogram\")\n\n# qqplot\ncoffee_pval_qq <- coffee_pca |> \n  arrange(p) |> \n  mutate(expected = -log10(ppoints(n())), \n         observed = -log10(p)) |> \n  filter(p <= 0.001 | (p > 0.001 & runif(n()) < 0.01)) |> \n  ggplot(aes(expected, observed)) +\n  geom_point() +\n  geom_abline() + \n  labs(title = \"Q-Q plot\")\n\n# manhattan plot\ncoffee_pval_man <- coffee_pca |> \n  filter(p < 0.01) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point() +\n  geom_hline(yintercept = -log10(5e-8), linetype = \"dashed\") +\n  facet_grid(~ number_chrom, \n             scale = \"free_x\", \n             space = \"free_x\",\n             switch = \"x\") +\n  labs(x = \"Chromosome\", \n       title = \"Manhattan plot\") +\n  manhattan_theme\n```\n:::\n\n\n\n\nCompose plots: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n((coffee_pval_hist + coffee_pval_qq) / coffee_pval_man) + \n  plot_annotation(\n    title = \"Caffeine consumption (mg/day)\"\n  )\n```\n\n::: {.cell-output-display}\n![](02-association_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\nInflation factor:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedian(qchisq(coffee_pca$p, df=1, lower.tail = F), na.rm = T)/qchisq(0.5, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.9885335\n```\n\n\n:::\n:::\n\n\n\n\n\n## Regional plots\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Zoom in on one of the SNPs\ncoffee_pca |> \n  filter(number_chrom == 7 & pos > 17244953 - 250e3 & pos < 17244953 + 250e3) |> \n  mutate(label = ifelse(p == min(p), \n                        paste(number_chrom, pos, sep = \":\"),\n                        NA)) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point() +\n  geom_text(aes(label = label), hjust = -0.1) +\n  geom_hline(yintercept = -log10(5e-8), linetype = \"dashed\")\n```\n\n::: {.cell-output-display}\n![](02-association_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Summary\n\n::: {.callout-tip}\n#### Key Points\n\n- TODO\n:::\n",
    "supporting": [
      "02-association_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}