{
  "hash": "15d7ec5f6d2980d1a1db947c1796c38e",
  "result": {
    "engine": "knitr",
    "markdown": "---\npagetitle: GWAS\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# Visualising GWAS\n\n:::{.callout-tip}\n#### Learning objectives\n\n- Produce Manhattan plots to visualise the association results across the genome.\n- Explore the association results and refine visualisations to focus on particular regions of interest.\n:::\n\n\n## Manhattan plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the libraries\nlibrary(tidyverse) # data manipulation\nlibrary(patchwork) # to compose plots\nlibrary(janitor)   # to clean column names\ntheme_set(theme_minimal())\n```\n:::\n\n\n\n\n\nImport the data and create custom theme for Manhattan plots: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee <- read_tsv(\"results/1000G_subset_nocovar.coffee.glm.linear\") |> \n  clean_names()\n  \nmanhattan_theme <- theme_minimal() +\n  theme(\n    axis.text.x = element_blank(),\n    axis.ticks.x = element_blank(),\n    panel.grid = element_blank(),\n    panel.spacing = unit(0.1, \"lines\"),\n    strip.background = element_blank()\n  )\n```\n:::\n\n\n\n\nWe can import and visualise the results:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoffee_pca <- read_tsv(\"results/1000G_subset_pca.coffee.glm.linear\") |> \n  clean_names()\n  \n# retain only the SNP test results\ncoffee_pca <- coffee_pca |> \n  filter(test == \"ADD\")\n\n# histogram of p-values\ncoffee_pval_hist <- coffee_pca |> \n  arrange(p) |> \n  mutate(expected = -log10(ppoints(n())), \n         observed = -log10(p)) |> \n  filter(p <= 0.001 | (p > 0.001 & runif(n()) < 0.01)) |> \n  ggplot(aes(p)) +\n  geom_histogram(binwidth = 0.01) +\n  labs(title = \"P-value histogram\")\n\n# qqplot\ncoffee_pval_qq <- coffee_pca |> \n  arrange(p) |> \n  mutate(expected = -log10(ppoints(n())), \n         observed = -log10(p)) |> \n  filter(p <= 0.001 | (p > 0.001 & runif(n()) < 0.01)) |> \n  ggplot(aes(expected, observed)) +\n  geom_point() +\n  geom_abline() + \n  labs(title = \"Q-Q plot\")\n\n# manhattan plot\ncoffee_pval_man <- coffee_pca |> \n  filter(p < 0.01) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point() +\n  geom_hline(yintercept = -log10(5e-8), linetype = \"dashed\") +\n  facet_grid(~ number_chrom, \n             scale = \"free_x\", \n             space = \"free_x\",\n             switch = \"x\") +\n  labs(x = \"Chromosome\", \n       title = \"Manhattan plot\") +\n  manhattan_theme\n```\n:::\n\n\n\n\nCompose plots: \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n((coffee_pval_hist + coffee_pval_qq) / coffee_pval_man) + \n  plot_annotation(\n    title = \"Caffeine consumption (mg/day)\"\n  )\n```\n\n::: {.cell-output-display}\n![](08-manhattan_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nInflation factor:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedian(qchisq(coffee_pca$p, df=1, lower.tail = F), na.rm = T)/qchisq(0.5, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.9771328\n```\n\n\n:::\n:::\n\n\n\n\n\n## Regional plots\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Zoom in on one of the SNPs\ncoffee_pca |> \n  filter(number_chrom == 7 & pos > 17244953 - 250e3 & pos < 17244953 + 250e3) |> \n  mutate(label = ifelse(p == min(p), \n                        paste(number_chrom, pos, sep = \":\"),\n                        NA)) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point() +\n  geom_text(aes(label = label), hjust = -0.1) +\n  geom_hline(yintercept = -log10(5e-8), linetype = \"dashed\")\n```\n\n::: {.cell-output-display}\n![](08-manhattan_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\nCalculate LD for target SNP:\n\n```bash\nplink2 --pfile data/plink/1000G_subset --out results/1000G_subset \\\n  --geno 0.05 --maf 0.01 --hwe 0.001 keep-fewhet \\\n  --mind 0.05 --keep results/1000G_subset.king.cutoff.in.id \\\n  --r2-unphased --ld-window-kb 500 --ld-snp rs4410790\n```\n\nVisualise:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhit <- read_tsv(\"results/1000G_subset.vcor\") |> \n  clean_names()\n\ncoffee_pca |> \n  filter(number_chrom == 7 & pos > 17244953 - 250e3 & pos < 17244953 + 250e3) |> \n  mutate(label = ifelse(p == min(p), \n                        paste(number_chrom, pos, sep = \":\"),\n                        NA)) |> \n  left_join(hit, by = c(\"id\" = \"id_b\")) |> \n  mutate(unphased_r2 = ifelse(is.na(unphased_r2), 0, unphased_r2)) |> \n  mutate(unphased_r2 = ifelse(p == min(p), 1, unphased_r2)) |> \n  ggplot(aes(pos, -log10(p))) +\n  geom_point(aes(colour = unphased_r2, size = unphased_r2)) +\n  geom_text(aes(label = label), hjust = -0.1) +\n  geom_hline(yintercept = -log10(5e-8), linetype = \"dashed\") +\n  scale_colour_gradient2(low = \"#313695\", \n                         mid = \"#ffffbf\", \n                         high = \"#a50026\", \n                         midpoint = 0.5)\n```\n\n::: {.cell-output-display}\n![](08-manhattan_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n## Summary\n\n::: {.callout-tip}\n#### Key Points\n\n- TODO\n:::\n",
    "supporting": [
      "08-manhattan_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}